<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Il Perturbante - Biblioteca Angelica (P01)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#000; --fg:#fff; --muted:#bbb; --accent:#1e88e5; --card:#111; --border:#333;
    }
    html, body { margin:0; padding:0; height:100%; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .stage { position: fixed; inset: 0; display: grid; place-items: center; background: var(--bg); }
    #slide { max-width: 100vw; max-height: calc(100vh - 120px); object-fit: contain; image-rendering: auto; }

    /* Controls */
    .controls {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.65) 35%, rgba(0,0,0,.85) 100%);
      padding: 10px 14px 12px; display: grid; gap: 8px; box-sizing: border-box;
    }
    .row { display: flex; align-items: center; gap: 12px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; min-width:110px;
      padding:10px 14px; border-radius:10px; border:1px solid var(--border);
      background:var(--card); color:var(--fg); font-weight:600; cursor:pointer; user-select:none;
    }
    .btn:active { transform: translateY(1px); }
    .time { font-variant-numeric: tabular-nums; min-width: 60px; text-align: center; color: var(--muted); }
    .slider { flex:1; display:flex; align-items:center; gap:10px; }
    input[type="range"] {
      -webkit-appearance:none; appearance:none; width:100%; height:6px; background:#444; border-radius:999px; outline:none;
    }
    input[type="range"]::-webkit-slider-thumb, input[type="range"]::-moz-range-thumb {
      width:18px; height:18px; border-radius:50%; background:var(--accent); border:none; cursor:pointer;
      box-shadow:0 0 0 4px rgba(30,136,229,0.25);
    }

    /* Overlay */
    .overlay {
      position: fixed; inset: 0; display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.75); backdrop-filter: blur(2px); padding:16px;
    }
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 18px 20px; max-width: 90vw;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
    }
    .hint { opacity: 0.85; font-size: 0.95rem; margin-top: 6px; }

    /* Language selector */
    .langbar {
      position: fixed; top: 10px; right: 10px; z-index: 10; display:flex; align-items:center; gap:8px;
      background: rgba(17,17,17,0.8); border:1px solid var(--border); padding:6px 10px; border-radius:10px;
      backdrop-filter: blur(2px);
    }
    label[for="lang"] { color: var(--muted); font-size: 0.9rem; }
    select {
      background: var(--card); color: var(--fg); border:1px solid var(--border); border-radius:8px; padding:6px 8px;
      min-width: 160px;
    }
  </style>
</head>
<body>
  <!-- Barra lingua -->
  <div class="langbar" aria-label="language selector">
    <label for="lang" id="langLabel">Lingua</label>
    <select id="lang" aria-labelledby="langLabel">
      <option value="IT">Italiano (IT)</option>
      <option value="EN">English (EN)</option>
      <option value="FR">Français (FR)</option>
      <option value="DE">Deutsch (DE)</option>
      <option value="RU">Русский (RU)</option>
      <option value="CN">中文 (CN)</option>
      <option value="HE">עברית (HE)</option>
      <option value="JA">日本語 (JA)</option>
      <option value="ES">Español (ES)</option>
    </select>
  </div>

  <!-- Audio -->
  <audio id="audio" preload="auto" autoplay playsinline></audio>

  <!-- Immagini (comuni per tutte le lingue) -->
  <div class="stage">
    <img id="slide" alt="" />
  </div>

  <!-- Controlli -->
  <div class="controls" id="controls" aria-label="">
    <div class="row">
      <button id="playPause" class="btn" type="button"></button>
    </div>
    <div class="row slider">
      <span id="cur" class="time">0:00</span>
      <input id="seek" type="range" min="0" max="0" step="0.01" value="0" aria-label="" />
      <span id="dur" class="time">0:00</span>
    </div>
  </div>

  <!-- Overlay autoplay -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="">
    <div class="card">
      <div id="ovTitle" style="font-size:1.1rem; font-weight:700; margin-bottom:6px;"></div>
      <div id="ovBody"></div>
      <button id="startBtn" class="btn" type="button"></button>
      <div id="ovHint" class="hint"></div>
    </div>
  </div>

  <script>
    (function() {
      // ==========================
      //   CONFIGURAZIONE PANNELLO
      // ==========================
      const PANEL_ID = 'P01';                 // <<-- cambia solo quando duplichi il file per altri pannelli
      const IMAGES_PATH = './';       // immagini comuni
      const IMAGE_EXTENSION = '.png';
      const IMAGE_PADDING = 2;                // 00, 01, 02, …
      const IMAGE_START_AT_ZERO = true;       // true => 00.png; false => 01.png
      const IMAGE_MAX = 999;                  // probing fino a questo numero

      // Tempi (in secondi): se [], verranno generati equidistanti sulla durata dell'audio
      let CUE_POINTS = []; // es. [0, 10, 21, 29, 38, 46, 58, 67, 85, 95, 105, 115, 120]

      // ==========================
      //       LOCALIZZAZIONE
      // ==========================
      const L10N = {
        IT: {
          title: 'Il Perturbante - Biblioteca Angelica (P01)',
          ui: {
            controlsLabel: 'controlli riproduzione',
            play: '▶︎ Riprendi',
            pause: '⏸ Pausa',
            position: 'posizione',
            alt: 'slideshow sincronizzato all’audio'
          },
          overlay: {
            title: 'Autoplay bloccato',
            body: 'Clicca <em>Avvia</em> per riprodurre l’audio e far partire la sequenza di immagini.',
            start: '▶︎ Avvia',
            hint: 'Suggerimento: consenti l’autoplay audio nelle preferenze del browser.'
          },
          noimg: 'Nessuna immagine trovata (attese 00.png, 01.png, …)'
        },
        EN: {
          title: 'The Uncanny - Biblioteca Angelica (P01)',
          ui: {
            controlsLabel: 'playback controls',
            play: '▶︎ Resume',
            pause: '⏸ Pause',
            position: 'position',
            alt: 'slideshow synchronized with audio'
          },
          overlay: {
            title: 'Autoplay blocked',
            body: 'Click <em>Start</em> to play the audio and launch the image sequence.',
            start: '▶︎ Start',
            hint: 'Hint: make sure audio autoplay is allowed in your browser settings.'
          },
          noimg: 'No images found (expected 00.png, 01.png, …)'
        },
        FR: {
          title: 'L’Inquiétant - Bibliothèque Angelica (P01)',
          ui: {
            controlsLabel: 'commandes de lecture',
            play: '▶︎ Reprendre',
            pause: '⏸ Pause',
            position: 'position',
            alt: 'diaporama synchronisé avec l’audio'
          },
          overlay: {
            title: 'Lecture automatique bloquée',
            body: 'Cliquez sur <em>Démarrer</em> pour lancer l’audio et la séquence d’images.',
            start: '▶︎ Démarrer',
            hint: 'Astuce : autorisez l’autoplay audio dans les préférences du navigateur.'
          },
          noimg: 'Aucune image trouvée (attendues 00.png, 01.png, …)'
        },
        DE: {
          title: 'Das Unheimliche - Biblioteca Angelica (P01)',
          ui: {
            controlsLabel: 'Wiedergabesteuerung',
            play: '▶︎ Fortsetzen',
            pause: '⏸ Pause',
            position: 'Position',
            alt: 'Diashow synchronisiert mit Audio'
          },
          overlay: {
            title: 'Autoplay blockiert',
            body: 'Klicken Sie auf <em>Start</em>, um Audio und Bildsequenz zu starten.',
            start: '▶︎ Start',
            hint: 'Hinweis: Autoplay in den Browser-Einstellungen erlauben.'
          },
          noimg: 'Keine Bilder gefunden (erwartet 00.png, 01.png, …)'
        },
        RU: {
          title: 'Зловещее - Библиотека Анджелика (P01)',
          ui: {
            controlsLabel: 'элементы управления воспроизведением',
            play: '▶︎ Возобновить',
            pause: '⏸ Пауза',
            position: 'позиция',
            alt: 'слайд-шоу, синхронизированное с аудио'
          },
          overlay: {
            title: 'Автовоспроизведение заблокировано',
            body: 'Нажмите <em>Запуск</em>, чтобы воспроизвести аудио и запустить показ изображений.',
            start: '▶︎ Запуск',
            hint: 'Подсказка: разрешите автовоспроизведение звука в настройках браузера.'
          },
          noimg: 'Изображения не найдены (ожидались 00.png, 01.png, …)'
        },
        CN: {
          title: '诡异 - 安杰利卡图书馆 (P01)',
          ui: {
            controlsLabel: '播放控制',
            play: '▶︎ 继续',
            pause: '⏸ 暂停',
            position: '位置',
            alt: '与音频同步的幻灯片'
          },
          overlay: {
            title: '自动播放已被阻止',
            body: '点击 <em>开始</em> 播放音频并启动图像序列。',
            start: '▶︎ 开始',
            hint: '提示：请在浏览器设置中允许音频自动播放。'
          },
          noimg: '未找到图像（应为 00.png、01.png、…）'
        },
        HE: {
          title: 'המפחיד - ספריית אנג׳ליקה (P01)',
          ui: {
            controlsLabel: 'בקרות ניגון',
            play: '▶︎ המשך',
            pause: '⏸ הפסקה',
            position: 'מיקום',
            alt: 'מצגת מסונכרנת עם האודיו'
          },
          overlay: {
            title: 'הפעלה אוטומטית נחסמה',
            body: 'לחץ <em>התחל</em> כדי להשמיע את האודיו ולהתחיל את רצף התמונות.',
            start: '▶︎ התחל',
            hint: 'רמז: אשר בהגדרות הדפדפן הפעלה אוטומטית של אודיו.'
          },
          noimg: 'לא נמצאו תמונות (צפוי 00.png, 01.png, …)'
        },
        JA: {
          title: '不気味なもの - アンジェリカ図書館 (P01)',
          ui: {
            controlsLabel: '再生コントロール',
            play: '▶︎ 再開',
            pause: '⏸ 一時停止',
            position: '位置',
            alt: '音声と同期したスライドショー'
          },
          overlay: {
            title: '自動再生がブロックされました',
            body: '<em>開始</em> をクリックすると、音声と画像シーケンスを開始します。',
            start: '▶︎ 開始',
            hint: 'ヒント：ブラウザ設定で音声の自動再生を許可してください。'
          },
          noimg: '画像が見つかりません（00.png、01.png、… を想定）'
        },
        ES: {
          title: 'Lo inquietante - Biblioteca Angelica (P01)',
          ui: {
            controlsLabel: 'controles de reproducción',
            play: '▶︎ Reanudar',
            pause: '⏸ Pausa',
            position: 'posición',
            alt: 'diapositivas sincronizadas con el audio'
          },
          overlay: {
            title: 'Reproducción automática bloqueada',
            body: 'Haz clic en <em>Iniciar</em> para reproducir el audio y lanzar la secuencia de imágenes.',
            start: '▶︎ Iniciar',
            hint: 'Consejo: permite el autoplay de audio en la configuración del navegador.'
          },
          noimg: 'No se encontraron imágenes (se esperaban 00.png, 01.png, …)'
        }
      };

      const RTL_LANGS = new Set(['HE']);

      // ==========================
      //        RIFERIMENTI DOM
      // ==========================
      const html = document.documentElement;
      const langSel = document.getElementById('lang');
      const audio = document.getElementById('audio');
      const slide = document.getElementById('slide');
      const controls = document.getElementById('controls');
      const playPause = document.getElementById('playPause');
      const seek = document.getElementById('seek');
      const tCur = document.getElementById('cur');
      const tDur = document.getElementById('dur');
      const overlay = document.getElementById('overlay');
      const startBtn = document.getElementById('startBtn');
      const ovTitle = document.getElementById('ovTitle');
      const ovBody = document.getElementById('ovBody');
      const ovHint = document.getElementById('ovHint');

      // ==========================
      //       STATO INTERNO
      // ==========================
      let images = [];
      let cues = [];
      let started = false;
      let duration = 0;
      let lastIndex = -1;
      let rafId = 0;
      let isUserScrubbing = false;
      let currentLang = 'IT';

      // ==========================
      //           UTILS
      // ==========================
      function fmtTime(s) {
        if (!isFinite(s)) return '0:00';
        s = Math.max(0, Math.floor(s));
        const m = Math.floor(s / 60);
        const ss = String(s % 60).padStart(2, '0');
        return `${m}:${ss}`;
      }

      function pad(n, k) { return String(n).padStart(k, '0'); }

      function loadImage(name) {
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error('not found: ' + name));
          img.src = name;
        });
      }

      async function discoverImages() {
        const arr = [];
        const start = IMAGE_START_AT_ZERO ? 0 : 1;
        for (let i = start; i <= IMAGE_MAX; i++) {
          const name = IMAGES_PATH + pad(i, IMAGE_PADDING) + IMAGE_EXTENSION;
          try {
            const img = await loadImage(name);
            arr.push(img);
          } catch {
            break; // interrompe alla prima mancante
          }
        }
        return arr;
      }

      function buildEquidistantCues(N, dur) {
        if (!N || dur <= 0) return [];
        const out = new Array(N);
        for (let i = 0; i < N; i++) out[i] = (i * dur) / N;
        return out;
      }

      function normalizeCues(userCues, N, dur) {
        if (!Array.isArray(userCues) || userCues.length !== N) {
          return buildEquidistantCues(N, dur);
        }
        const c = userCues.map(x => Math.max(0, Math.min(dur, Number(x) || 0)));
        c.sort((a,b) => a - b);
        if (c[0] > 0) c[0] = 0;                     // prima immagine da 0s
        if (c[c.length-1] > dur) c[c.length-1] = Math.max(0, dur - 0.001);
        return c;
      }

      function indexFromTime(t) {
        const N = images.length;
        if (N === 0) return -1;
        if (t <= cues[0]) return 0;
        for (let i = N - 1; i >= 0; i--) {
          if (t >= cues[i]) return i;
        }
        return 0;
      }

      function showIndex(idx) {
        if (idx < 0 || idx >= images.length) return;
        if (idx !== lastIndex) {
          slide.src = images[idx].src;
          lastIndex = idx;
        }
      }

      function updateUI() {
        if (!isUserScrubbing) seek.value = String(audio.currentTime);
        tCur.textContent = fmtTime(audio.currentTime);
      }

      function tick() {
        const idx = indexFromTime(audio.currentTime);
        showIndex(idx);
        updateUI();
        if (!audio.ended) {
          rafId = requestAnimationFrame(tick);
        } else {
          showIndex(images.length - 1);
          setPlayStateUI();
        }
      }

      function setPlayStateUI() {
        const t = L10N[currentLang].ui;
        playPause.textContent = audio.paused ? t.play : t.pause;
      }

      function applyLang(lang) {
        currentLang = lang in L10N ? lang : 'IT';
        const pack = L10N[currentLang];

        // html lang/dir e <title>
        document.title = pack.title;
        html.lang = currentLang.toLowerCase() === 'cn' ? 'zh-CN' :
                    currentLang.toLowerCase() === 'he' ? 'he' :
                    currentLang.toLowerCase();
        html.dir = RTL_LANGS.has(currentLang) ? 'rtl' : 'ltr';

        // UI testi + aria
        controls.setAttribute('aria-label', pack.ui.controlsLabel);
        seek.setAttribute('aria-label', pack.ui.position);
        slide.alt = pack.ui.alt;
        setPlayStateUI();

        // Overlay
        ovTitle.innerHTML = pack.overlay.title;
        ovBody.innerHTML = pack.overlay.body;
        startBtn.textContent = pack.overlay.start;
        ovHint.textContent = pack.overlay.hint;
        overlay.setAttribute('aria-label', pack.overlay.title);

        // Audio per lingua
        const src = `${PANEL_ID}_${currentLang}.mp3`;
        const wasPlaying = !audio.paused && !audio.ended;
        audio.src = src;

        // Prova autoplay; se bloccato mostra overlay
        audio.play().then(() => {
          overlay.style.display = 'none';
          setPlayStateUI();
          startIfReady();
        }).catch(() => {
          overlay.style.display = 'flex';
          setPlayStateUI();
        });

        // Salva scelta
        try { localStorage.setItem('panel_lang', currentLang); } catch {}
      }

      function startIfReady() {
        if (started) return;
        if (!images.length || !isFinite(audio.duration) || audio.duration <= 0) return;
        duration = audio.duration;
        seek.max = String(duration);
        tDur.textContent = fmtTime(duration);

        cues = normalizeCues(CUE_POINTS, images.length, duration);

        started = true;
        showIndex(0);
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(tick);
      }

      async function init() {
        // Carica immagini comuni
        images = await discoverImages();
        if (!images.length) {
          // Placeholder locale
          const msg = (L10N[currentLang] || L10N.IT).noimg;
          const ph = new Blob(['data:image/svg+xml;utf8,' + encodeURIComponent(
            `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600">
              <rect width="100%" height="100%" fill="#111"/>
              <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                    fill="#fff" font-family="sans-serif" font-size="28">${msg}</text>
            </svg>`)], { type: 'image/svg+xml' });
          slide.src = URL.createObjectURL(ph);
        } else {
          slide.src = images[0].src;
        }

        // Ripristina lingua salvata o default IT
        let saved = 'IT';
        try {
          saved = localStorage.getItem('panel_lang') || 'IT';
        } catch {}
        langSel.value = L10N[saved] ? saved : 'IT';
        applyLang(langSel.value);

        // Metadati audio
        const onMeta = () => {
          duration = audio.duration || 0;
          seek.max = String(duration);
          tDur.textContent = fmtTime(duration);
          setPlayStateUI();
          startIfReady();
        };
        if (audio.readyState >= 1) onMeta();
        audio.addEventListener('loadedmetadata', onMeta, { once: true });

        // Ritenta autoplay al primo gesto utente
        ['click','touchstart','keydown'].forEach(evt => {
          window.addEventListener(evt, () => { if (audio.paused) {
            audio.play().then(() => overlay.style.display='none').catch(()=>{});
          } }, { passive: true, once: true });
        });

        // Aggiorna barra durante la riproduzione
        audio.addEventListener('timeupdate', () => {
          if (!started) return;
          if (!isUserScrubbing) {
            seek.value = String(audio.currentTime);
            tCur.textContent = fmtTime(audio.currentTime);
          }
        });
        audio.addEventListener('play',  () => { setPlayStateUI(); cancelAnimationFrame(rafId); rafId = requestAnimationFrame(tick); });
        audio.addEventListener('pause', () => setPlayStateUI());
        audio.addEventListener('ended', () => {
          setPlayStateUI(); showIndex(images.length - 1); seek.value = String(duration); tCur.textContent = fmtTime(duration);
        });
      }

      // Eventi UI
      langSel.addEventListener('change', () => applyLang(langSel.value));

      document.getElementById('playPause').addEventListener('click', async () => {
        if (audio.paused) {
          try { await audio.play(); } catch {}
        } else {
          audio.pause();
        }
        setPlayStateUI();
        if (!audio.paused) {
          cancelAnimationFrame(rafId);
          rafId = requestAnimationFrame(tick);
        }
      });

      seek.addEventListener('input', () => {
        isUserScrubbing = true;
        const t = Number(seek.value);
        if (isFinite(t)) {
          audio.currentTime = Math.min(duration || 0, Math.max(0, t));
          showIndex(indexFromTime(audio.currentTime));
          tCur.textContent = fmtTime(audio.currentTime);
        }
      });
      ['change','pointerup','mouseup','touchend','keyup'].forEach(evt => {
        seek.addEventListener(evt, () => {
          isUserScrubbing = false;
          if (!audio.paused) {
            cancelAnimationFrame(rafId);
            rafId = requestAnimationFrame(tick);
          } else {
            updateUI();
          }
        }, { passive: true });
      });

      document.getElementById('startBtn')?.addEventListener('click', async () => {
        try { await audio.play(); overlay.style.display = 'none'; } catch (e) { console.error(e); }
        setPlayStateUI(); startIfReady();
      });

      // Avvio
      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
