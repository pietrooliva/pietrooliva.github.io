<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Perturbante ‚Äì Biblioteca Angelica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#000; --fg:#fff; --muted:#bbb; --accent:#1e88e5; --card:#111; --border:#333; }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .stage { position: fixed; inset: 0; display: grid; place-items: center; background: var(--bg); }
    video { max-width: 100vw; max-height: calc(100vh - 110px); background:#000; }
    .controls { position: fixed; left:0; right:0; bottom:0;
      background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.65) 35%, rgba(0,0,0,.85) 100%);
      padding: 10px 14px 12px; display: grid; gap: 8px; box-sizing: border-box; }
    .row { display:flex; align-items:center; gap:12px; flex-wrap: wrap; }
    .btn { display:inline-flex; align-items:center; justify-content:center; min-width:110px;
      padding:10px 14px; border-radius:10px; border:1px solid var(--border);
      background:var(--card); color:var(--fg); font-weight:600; cursor:pointer; user-select:none; }
    .btn:active { transform: translateY(1px); }
    .time { font-variant-numeric: tabular-nums; min-width:60px; text-align:center; color:var(--muted); }
    .slider { flex:1; display:flex; align-items:center; gap:10px; min-width:220px; }
    input[type="range"] { -webkit-appearance:none; appearance:none; width:100%; height:6px; background:#444; border-radius:999px; outline:none; }
    input[type="range"]::-webkit-slider-thumb, input[type="range"]::-moz-range-thumb {
      width:18px; height:18px; border-radius:50%; background:var(--accent); border:none; cursor:pointer;
      box-shadow:0 0 0 4px rgba(30,136,229,0.25);
    }
    select { background:var(--card); color:var(--fg); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px; font-weight:600; }
    .overlay { position: fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.75); backdrop-filter: blur(2px); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:18px 20px; max-width:90vw;
      box-shadow:0 10px 30px rgba(0,0,0,0.5); text-align:center; }
    .hint { opacity:.85; font-size:.95rem; margin-top:6px; }
    video::cue { background: rgba(0,0,0,.55); color:#fff; font-size:1.05rem; }
    .rtl::cue { direction: rtl; unicode-bidi: plaintext; text-align: start; }
    .err { color:#f66; font-weight:600; margin-top:8px; }
  </style>
</head>
<body>
  <div class="stage">
    <!-- Autoplay muto: verr√† smutato su click -->
    <video id="vid" preload="auto" playsinline muted crossorigin="anonymous" controlslist="nodownload noplaybackrate">
      <source id="src" src="" type="video/mp4" />
      <track id="tr-en" kind="subtitles" srclang="en" label="English" src="EN/promo_en.vtt" default>
      <track id="tr-de" kind="subtitles" srclang="de" label="Deutsch" src="DE/promo_de.vtt">
      <track id="tr-es" kind="subtitles" srclang="es" label="Espa√±ol" src="ES/promo_es.vtt">
      <track id="tr-fr" kind="subtitles" srclang="fr" label="Fran√ßais" src="FR/promo_fr.vtt">
      <track id="tr-he" kind="subtitles" srclang="he" label="◊¢◊ë◊®◊ô◊™" src="HE/promo_he.vtt">
      <track id="tr-ja" kind="subtitles" srclang="ja" label="Êó•Êú¨Ë™û" src="JA/promo_ja.vtt">
      <track id="tr-zh" kind="subtitles" srclang="zh" label="‰∏≠Êñá" src="CN/promo_zh.vtt">
      <track id="tr-ru" kind="subtitles" srclang="ru" label="–†—É—Å—Å–∫–∏–π" src="RU/promo_ru.vtt">
    </video>
  </div>

  <div class="controls" aria-label="controlli riproduzione">
    <div class="row">
      <button id="playPause" class="btn" type="button">‚è∏ Pausa</button>
      <label for="subs" style="color:var(--muted); font-weight:600;">Sottotitoli:</label>
      <select id="subs" aria-label="Seleziona lingua sottotitoli">
        <option value="off">OFF</option>
        <option value="en">EN ‚Äì English</option>
        <option value="de">DE ‚Äì Deutsch</option>
        <option value="es">ES ‚Äì Espa√±ol</option>
        <option value="fr">FR ‚Äì Fran√ßais</option>
        <option value="he">HE ‚Äì ◊¢◊ë◊®◊ô◊™</option>
        <option value="ja">JA ‚Äì Êó•Êú¨Ë™û</option>
        <option value="zh">CN ‚Äì ‰∏≠Êñá</option>
        <option value="ru">RU ‚Äì –†—É—Å—Å–∫–∏–π</option>
      </select>
    </div>
    <div class="row slider">
      <span id="cur" class="time">0:00</span>
      <input id="seek" type="range" min="0" max="0" step="0.01" value="0" aria-label="posizione" />
      <span id="dur" class="time">0:00</span>
    </div>
  </div>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="Autoplay bloccato">
    <div class="card">
      <div style="font-size:1.1rem; font-weight:700; margin-bottom:6px;">Avvio video</div>
      <div>Clicca <em>Avvia</em> per riprodurre il video.</div>
      <button id="startBtn" class="btn" type="button">‚ñ∂Ô∏é Avvia</button>
      <div id="err" class="err" style="display:none;"></div>
      <div class="hint">Nota: i link Google Drive a volte non forniscono un <code>video/mp4</code> diretto.</div>
    </div>
  </div>

  <script>
  (function() {
    const vid = document.getElementById('vid');
    const srcEl = document.getElementById('src');
    const playPause = document.getElementById('playPause');
    const seek = document.getElementById('seek');
    const tCur = document.getElementById('cur');
    const tDur = document.getElementById('dur');
    const subs = document.getElementById('subs');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const errBox = document.getElementById('err');

    // üëâ Sostituisci qui con il tuo ID (o metti un file locale)
    const videoSrc = 'https://drive.google.com/uc?export=download&id=1fFwKAS7E-aSmU5ov4lp6Fur_UQYQ6Ovy';

    let rafId = 0, duration = 0, isUserScrubbing = false, started = false;

    function showError(msg) {
      overlay.style.display = 'flex';
      errBox.style.display = 'block';
      errBox.textContent = msg;
    }
    function clearError() { errBox.style.display = 'none'; errBox.textContent = ''; }

    function fmtTime(s) {
      if (!isFinite(s)) return '0:00';
      s = Math.max(0, Math.floor(s));
      const m = Math.floor(s / 60), ss = String(s % 60).padStart(2,'0');
      return `${m}:${ss}`;
    }
    function setPlayStateUI() {
      playPause.textContent = vid.paused ? '‚ñ∂Ô∏é Riprendi' : '‚è∏ Pausa';
    }
    function tick() {
      if (!isUserScrubbing) seek.value = String(vid.currentTime || 0);
      tCur.textContent = fmtTime(vid.currentTime || 0);
      if (!vid.ended) rafId = requestAnimationFrame(tick);
      else setPlayStateUI();
    }
    function startIfReady() {
      if (started) return;
      if (!isFinite(vid.duration) || vid.duration <= 0) return;
      duration = vid.duration;
      seek.max = String(duration);
      tDur.textContent = fmtTime(duration);
      started = true;
      cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(tick);
    }

    async function tryAutoplay() {
      clearError();
      try {
        // Autoplay muto (consentito): poi smuteremo su click
        vid.muted = true;
        await vid.play();
        overlay.style.display = 'none';
        setPlayStateUI(); startIfReady();
      } catch {
        overlay.style.display = 'flex';
        setPlayStateUI();
      }
    }

    function applySubtitles(langCode) {
      for (const tr of vid.textTracks) tr.mode = 'disabled';
      vid.classList.remove('rtl');
      if (langCode === 'off') return;
      let target = null;
      for (const tr of vid.textTracks) {
        if ((tr.language || '').toLowerCase() === langCode) { target = tr; break; }
      }
      if (target) {
        target.mode = 'showing';
        if (langCode === 'he') vid.classList.add('rtl');
      }
    }

    // UI
    playPause.addEventListener('click', async () => {
      if (vid.paused) { try { await vid.play(); } catch(e) { showError('Impossibile avviare la riproduzione.'); } }
      else vid.pause();
      setPlayStateUI();
      if (!vid.paused) { cancelAnimationFrame(rafId); rafId = requestAnimationFrame(tick); }
    });

    seek.addEventListener('input', () => {
      isUserScrubbing = true;
      const t = Number(seek.value);
      if (isFinite(t)) {
        vid.currentTime = Math.min(duration || 0, Math.max(0, t));
        tCur.textContent = fmtTime(vid.currentTime);
      }
    });
    ['change','pointerup','mouseup','touchend','keyup'].forEach(evt => {
      seek.addEventListener(evt, () => {
        isUserScrubbing = false;
        if (!vid.paused) { cancelAnimationFrame(rafId); rafId = requestAnimationFrame(tick); }
        else { tCur.textContent = fmtTime(vid.currentTime || 0); }
      }, { passive: true });
    });

    subs.addEventListener('change', () => applySubtitles(subs.value));

    startBtn?.addEventListener('click', async () => {
      clearError();
      try {
        // su gesto utente: (ri)carica e smuta in sicurezza
        if (vid.paused && vid.currentTime === 0) { /* no-op */ }
        vid.muted = false;              // consenti audio dopo il gesto
        await vid.play();
        overlay.style.display = 'none';
        setPlayStateUI(); startIfReady();
      } catch (e) {
        showError('Il browser non √® riuscito a riprodurre il video. Se usi Google Drive, il file potrebbe non essere servito come video/mp4.');
        console.error(e);
      }
    });

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      // Imposta sempre la sorgente da JS e forza il load
      srcEl.src = videoSrc;
      vid.load();

      const onMeta = () => { duration = vid.duration || 0; seek.max = String(duration); tDur.textContent = fmtTime(duration); setPlayStateUI(); startIfReady(); };
      if (vid.readyState >= 1) onMeta();
      vid.addEventListener('loadedmetadata', onMeta, { once: true });

      // Eventi di errore/rete -> messaggio chiaro
      vid.addEventListener('error', () => showError('Errore di caricamento video (sorgente non valida o bloccata).'));
      vid.addEventListener('stalled', () => showError('Connessione bloccata/stalled durante il caricamento del video.'));
      vid.addEventListener('abort', () => showError('Caricamento video interrotto.'));

      // Prova autoplay muto; se fallisce mostra overlay
      tryAutoplay();

      subs.value = 'off';
      applySubtitles('off');

      vid.addEventListener('timeupdate', () => {
        if (!started) return;
        if (!isUserScrubbing) {
          seek.value = String(vid.currentTime || 0);
          tCur.textContent = fmtTime(vid.currentTime || 0);
        }
      });
      vid.addEventListener('play',  () => { setPlayStateUI(); cancelAnimationFrame(rafId); rafId = requestAnimationFrame(tick); });
      vid.addEventListener('pause', () => setPlayStateUI());
      vid.addEventListener('ended', () => { setPlayStateUI(); seek.value = String(duration); tCur.textContent = fmtTime(duration); });
    });
  })();
  </script>
</body>
</html>
