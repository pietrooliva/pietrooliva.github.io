<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Didattica Aumentata | Dr. P.OLIVA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
    <script src="libs/aframe-master.min.js"></script>
    <script src="libs/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    <script src="libs/gesture-detector.js"></script>
  </head>
  <body>
    <div id="splash" style="
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        text-align: center;
        z-index: 9999;">
      <div>
        <h1>È necessario l'accesso ai sensori di movimento di questo dispositivo</h1>
        <button id="allowButton" style="
                padding: 10px 20px;
                font-size: 16px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                border: 2px solid white;
                border-radius: 5px;">
          Consentire
        </button>
      </div>
    </div>

    <a-scene 
      gesture-detector 
      embedded 
      arjs="trackingMethod: best; sourceType: webcam;" 
      renderer="
        antialias: true; 
        precision: highp; 
        renderer.outputEncoding = THREE.sRGBEncoding;
        physicallyCorrectLights: true; 
        shadowMap.enabled: false; 
        toneMapping: ACESFilmicToneMapping;">
      <a-assets>
        <a-asset-item id="model1" src="models/brocca/scene.gltf"></a-asset-item>
        <a-asset-item id="model2" src="models/coin/scene.gltf"></a-asset-item>
        <audio id="audio1" src="models/brocca/background.mp3"></audio>
        <audio id="audio2" src="models/coin/background.mp3"></audio>
      </a-assets>

      <a-light type="ambient" color="#ffffff" intensity="5"></a-light>
      <a-light type="directional" color="#ffffff" intensity="9" position="5 10 5"></a-light>

      <a-entity 
        id="animatedModel1"
        gltf-model="#model1"
        position="0 -0.02 -0.5"
        scale="0.02 0.02 0.02"
        rotation="0 0 220"
        class="clickable">
      </a-entity>

      <a-entity 
        id="animatedModel2"
        gltf-model="#model2"
        position="0 -0.02 -0.5"
        scale="0.02 0.02 0.02"
        rotation="0 0 220"
        class="clickable"
        visible="false">
      </a-entity>

      <a-entity camera></a-entity>
    </a-scene>

    <button id="audioButton" style="position: fixed; bottom: 10px; left: 10px; padding: 2vw 1vw; font-size: min(2vw, 18px); background: rgba(0, 0, 0, 0.8); color: white; border: none; border-radius: 5px;">
      Riproduci Audio
    </button>

    <button id="animationButton" style="position: fixed; bottom: 10px; right: 10px; padding: 2vw 1vw; font-size: min(2vw, 18px); background: rgba(0, 0, 0, 0.8); color: white; border: none; border-radius: 5px;">
      Avvia Animazione
    </button>

    <button id="previousButton" style="position: fixed; bottom: 20px; left: 10px; padding: 2vw 1vw; font-size: min(2vw, 18px); background: rgba(0, 0, 0, 0.8); color: white; border: none; border-radius: 5px;">
      Indietro
    </button>

    <button id="nextButton" style="position: fixed; bottom: 20px; right: 10px; padding: 2vw 1vw; font-size: min(2vw, 18px); background: rgba(0, 0, 0, 0.8); color: white; border: none; border-radius: 5px;">
      Avanti
    </button>

    <script>
      const splash = document.getElementById('splash');
      const allowButton = document.getElementById('allowButton');
      const audio1 = document.getElementById('audio1');
      const audio2 = document.getElementById('audio2');
      const audioButton = document.getElementById('audioButton');
      const animationButton = document.getElementById('animationButton');
      const model1 = document.getElementById('animatedModel1');
      const model2 = document.getElementById('animatedModel2');
      const previousButton = document.getElementById('previousButton');
      const nextButton = document.getElementById('nextButton');

      let currentModel = 1;
      let isAnimationActive = false;

      model1.addEventListener('model-loaded', () => {
        const model = model1.getObject3D('mesh');
        if (model && model.animations && model.animations.length > 0) {
          isNativeAnimation = true;
        }
      });

      animationButton.addEventListener('click', () => {
        if (isNativeAnimation) {
          toggleNativeAnimation();
        } else {
          toggleCustomRotation();
        }
      });

      function toggleNativeAnimation() {
        if (!isAnimationActive) {
          model1.setAttribute('animation-mixer', '');
          animationButton.textContent = "Ferma Animazione";
        } else {
          model1.removeAttribute('animation-mixer');
          animationButton.textContent = "Avvia Animazione";
        }
        isAnimationActive = !isAnimationActive;
      }

      function toggleCustomRotation() {
        if (!isAnimationActive) {
          model1.setAttribute('constant-rotation', 'speed: 30');
          animationButton.textContent = "Ferma Animazione";
        } else {
          model1.removeAttribute('constant-rotation');
          animationButton.textContent = "Avvia Animazione";
        }
        isAnimationActive = !isAnimationActive;
      }

      audioButton.addEventListener('click', () => {
        if (audio1.paused) {
          audio1.play();
          audioButton.textContent = "Interrompi Audio";
        } else {
          audio1.pause();
          audioButton.textContent = "Riproduci Audio";
        }
      });

      allowButton.addEventListener('click', async () => {
        if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
          try {
            const permission = await DeviceMotionEvent.requestPermission();
            if (permission === 'granted') {
              splash.style.display = 'none';
            } else {
              alert('Permesso negato. Questa esperienza richiede l’uso dei sensori di movimento.');
            }
          } catch (err) {
            console.error('Errore nella richiesta di permesso per i sensori di movimento:', err);
            alert('Si è verificato un errore. Controlla le impostazioni del tuo dispositivo.');
          }
        } else {
          console.warn('DeviceMotionEvent non supportato o non richiede permessi.');
          splash.style.display = 'none';
        }
      });

      window.addEventListener('load', () => {
        if (!('DeviceMotionEvent' in window)) {
          console.warn('DeviceMotionEvent is not supported on this device.');
          splash.style.display = 'none';
        }
      });

      AFRAME.registerComponent('constant-rotation', {
        schema: { speed: { type: 'number', default: 30 } },
        tick: function (time, timeDelta) {
          const rotation = this.el.object3D.rotation;
          const delta = THREE.Math.degToRad(this.data.speed) * (timeDelta / 1000);
          rotation.y += delta;
        }
      });

      previousButton.addEventListener('click', () => {
        currentModel = currentModel === 1 ? 2 : 1;
        if (currentModel === 1) {
          model1.setAttribute('visible', true);
          model2.setAttribute('visible', false);
        } else {
          model1.setAttribute('visible', false);
          model2.setAttribute('visible', true);
        }
      });

      nextButton.addEventListener('click', () => {
        currentModel = currentModel === 1 ? 2 : 1;
        if (currentModel === 1) {
          model1.setAttribute('visible', true);
          model2.setAttribute('visible', false);
        } else {
          model1.setAttribute('visible', false);
          model2.setAttribute('visible', true);
        }
      });
    </script>
  </body>
</html>
