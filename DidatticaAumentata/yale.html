<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modello 3D Interattivo</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        AFRAME.registerComponent('constant-rotation', {
            schema: { speed: { type: 'number', default: 0.5 } },
            init: function () {
                this.angle = 0;
                this.lastTime = performance.now();
                this.rotateModel();
            },
            rotateModel: function () {
                let el = this.el;
                let speed = this.data.speed;
                const animate = () => {
                    let now = performance.now();
                    let delta = (now - this.lastTime) / 1000;
                    this.lastTime = now;
                    this.angle += speed * delta * 60;
                    el.object3D.rotation.y = THREE.MathUtils.degToRad(this.angle);
                    requestAnimationFrame(animate);
                };
                animate();
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            const permissionOverlay = document.getElementById("permission-overlay");
            const allowButton = document.getElementById("allow-button");
            const scene = document.querySelector("a-scene");
            const animatedModel = document.getElementById("animated-model");
            const soundButton = document.getElementById("sound-button");
            const audioElement = document.getElementById("background-audio");
            let isAudioPlaying = false;

            allowButton.addEventListener("click", async function () {
                try {
                    if (typeof DeviceMotionEvent.requestPermission === 'function') {
                        let permission = await DeviceMotionEvent.requestPermission();
                        if (permission === 'granted') {
                            permissionOverlay.style.display = "none";
                        } else {
                            alert("Permesso non concesso. L'interazione sarÃ  limitata.");
                        }
                    } else {
                        permissionOverlay.style.display = "none";
                    }
                } catch (error) {
                    console.error("Errore nella richiesta di permesso:", error);
                }
            });

            soundButton.addEventListener("click", function () {
                if (isAudioPlaying) {
                    audioElement.pause();
                    soundButton.textContent = "Riproduci Audio";
                } else {
                    audioElement.play();
                    soundButton.textContent = "Ferma Audio";
                }
                isAudioPlaying = !isAudioPlaying;
            });

            animatedModel.addEventListener('model-loaded', function () {
                let bbox = new THREE.Box3().setFromObject(animatedModel.object3D);
                let size = new THREE.Vector3();
                bbox.getSize(size);

                let scaleFactor = window.innerWidth > 600 ? 1.0 : 0.1;
                animatedModel.setAttribute('scale', `${scaleFactor} ${scaleFactor} ${scaleFactor}`);
            });

            animatedModel.addEventListener("mouseenter", function () {
                animatedModel.setAttribute("scale", "1.2 1.2 1.2");
            });

            animatedModel.addEventListener("mouseleave", function () {
                let defaultScale = window.innerWidth > 600 ? "1.0 1.0 1.0" : "0.1 0.1 0.1";
                animatedModel.setAttribute("scale", defaultScale);
            });

            animatedModel.addEventListener("click", function () {
                alert("Hai cliccato sul modello 3D!");
            });
        });
    </script>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        #permission-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); display: flex;
            align-items: center; justify-content: center; flex-direction: column;
            color: white; text-align: center;
        }
        #permission-overlay button {
            margin-top: 10px; padding: 10px; font-size: 18px;
        }
        #controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 10px;
        }
        #controls button {
            padding: 10px; font-size: 16px; margin: 5px;
        }
    </style>
</head>
<body>
    <div id="permission-overlay">
        <p>Questo sito utilizza i sensori del tuo dispositivo. Concedi il permesso per un'esperienza completa.</p>
        <button id="allow-button">Consenti</button>
    </div>

    <a-scene>
        <a-assets>
            <a-asset-item id="model" src="modello.glb"></a-asset-item>
        </a-assets>

        <a-entity id="animated-model"
            gltf-model="#model"
            position="0 1 -3"
            rotation="0 180 0"
            constant-rotation="speed: 0.5">
        </a-entity>

        <a-camera position="0 1.6 0">
            <a-cursor></a-cursor>
        </a-camera>
    </a-scene>

    <div id="controls">
        <button id="sound-button">Riproduci Audio</button>
    </div>

    <audio id="background-audio" loop>
        <source src="audio.mp3" type="audio/mp3">
        Il tuo browser non supporta l'elemento audio.
    </audio>
</body>
</html>
