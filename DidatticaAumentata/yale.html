<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIDATTICA AUMENTATA</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <!-- Splash Screen -->
    <div id="splash" style="position: fixed; background: rgba(0, 0, 0, 0.8); color: white; width: 100vw; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;">
      <h1>Benvenuto! Abilita i sensori per proseguire</h1>
      <button id="allowButton" style="padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px;">Consenti</button>
    </div>

    <!-- AR Scene -->
    <a-scene embedded arjs="trackingMethod: best; sourceType: webcam;">
      <a-assets>
        <a-asset-item id="model" src="models/yale/scene.gltf"></a-asset-item>
        <audio id="background-audio" src="models/yale/background.mp3"></audio>
      </a-assets>

      <a-entity 
        gltf-model="#model" 
        position="0 0 0" 
        scale="0.005 0.005 0.005" 
        rotation="-90 180 180" 
        class="clickable" 
        id="animatedModel"
        interaction-handler>
      </a-entity>

      <a-entity camera></a-entity>
    </a-scene>

    <!-- Audio and Animation Buttons -->
    <div style="position: absolute; bottom: 20px; width: 100%; text-align: center; z-index: 1000;">
      <button id="audioButton" style="margin: 5px; padding: 10px 20px; background: rgba(0, 0, 0, 0.8); color: white; border: none; border-radius: 5px;">Riproduci Audio</button>
      <button id="animationButton" style="margin: 5px; padding: 10px 20px; background: rgba(0, 0, 0, 0.8); color: white; border: none; border-radius: 5px;">Avvia Animazione</button>
    </div>

    <script>
      const splash = document.getElementById('splash');
      const allowButton = document.getElementById('allowButton');
      const audioElement = document.getElementById('background-audio');
      const audioButton = document.getElementById('audioButton');
      const animationButton = document.getElementById('animationButton');
      const animatedModel = document.getElementById('animatedModel');

      let isAnimationActive = false;

      // Richiesta permessi sensori
      allowButton.addEventListener('click', async () => {
        splash.style.display = 'none';
        try {
          if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            const permissionState = await DeviceOrientationEvent.requestPermission();
            if (permissionState === 'granted') {
              alert('Permessi sensori concessi.');
            } else {
              alert('Permessi negati. Alcune funzionalità potrebbero non funzionare correttamente.');
            }
          } else {
            alert('I sensori sono già disponibili o non necessari.');
          }
        } catch (error) {
          alert('Errore durante la richiesta dei permessi: ' + error);
        }
      });

      // Pulsante audio
      audioButton.addEventListener('click', () => {
        if (audioElement.paused) {
          audioElement.play();
          audioButton.textContent = "Interrompi Audio";
        } else {
          audioElement.pause();
          audioButton.textContent = "Riproduci Audio";
        }
      });

      // Pulsante animazione
      animationButton.addEventListener('click', () => {
        if (!isAnimationActive) {
          animatedModel.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000');
          animationButton.textContent = "Ferma Animazione";
          isAnimationActive = true;
        } else {
          animatedModel.removeAttribute('animation');
          animationButton.textContent = "Avvia Animazione";
          isAnimationActive = false;
        }
      });

      // Manipolazione del modello con mouse e touch
      AFRAME.registerComponent('interaction-handler', {
        init: function () {
          this.isMouseDown = false;
          this.previousMousePosition = { x: 0, y: 0 };

          const canvas = this.el.sceneEl.canvas;
          if (!canvas) {
            this.el.sceneEl.addEventListener('render-target-loaded', () => this.initListeners());
          } else {
            this.initListeners();
          }
        },

        initListeners: function () {
          const canvas = this.el.sceneEl.canvas;

          canvas.addEventListener('mousedown', this.onMouseDown.bind(this));
          canvas.addEventListener('mouseup', this.onMouseUp.bind(this));
          canvas.addEventListener('mousemove', this.onMouseMove.bind(this));
          canvas.addEventListener('wheel', this.onMouseWheel.bind(this));
        },

        onMouseDown: function (event) {
          this.isMouseDown = true;
          this.previousMousePosition.x = event.clientX;
          this.previousMousePosition.y = event.clientY;
        },

        onMouseUp: function () {
          this.isMouseDown = false;
        },

        onMouseMove: function (event) {
          if (!this.isMouseDown) return;

          const deltaX = event.clientX - this.previousMousePosition.x;
          const deltaY = event.clientY - this.previousMousePosition.y;
          const object3D = this.el.object3D;

          object3D.rotation.y += deltaX * 0.01;
          object3D.rotation.x += deltaY * 0.01;

          this.previousMousePosition.x = event.clientX;
          this.previousMousePosition.y = event.clientY;
        },

        onMouseWheel: function (event) {
          const object3D = this.el.object3D;
          const scaleFactor = event.deltaY > 0 ? 0.9 : 1.1;
          object3D.scale.multiplyScalar(scaleFactor);
        }
      });
    </script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }
    </style>
  </body>
</html>
